# AstrBot 自主学习插件

# 功能尚未完善！开发中！请勿使用

一个功能完整的智能对话自学习插件，实现了QQ消息智能捕获、多维度分析、渐进式学习和人格动态优化的一坨解决方案。

## 🎯 核心特性

### 🔥 智能消息处理系统
- **灵活QQ号配置**: 支持指定QQ号列表或全用户消息抓取
- **分群数据存储**: 每个群独立SQLite数据库（`群号_ID.db`格式）
- **实时消息捕获**: 异步消息收集，支持批量写入优化
- **智能数据清洗**: 自动去重、长度过滤、内容质量检查

### 🧠 多维度分析引擎
- **深度用户画像**: 活动时间模式、消息频率分析、话题偏好挖掘
- **社交图谱构建**: 自动识别@关系、回复关系，量化社交强度
- **情境感知学习**: 基于时间、群氛围、用户状态的上下文分析
- **身份关联映射**: QQ号、昵称、真实身份的智能关联

### 🚀 渐进式学习架构
- **双模型策略**: 
  - 弱模型(gpt-4o-mini)快速筛选，降低成本
  - 强模型(gpt-4o)深度提炼，保证质量
- **质量监控体系**: 一致性检查、稳定性监控、偏移检测
- **自适应学习**: 根据质量评估动态调整学习策略
- **批处理优化**: 智能批次调度，避免资源浪费

### 🎭 人格进化系统
- **动态人格更新**: 基于框架默认人格进行智能优化
- **对话样本管理**: 自动筛选优质对话加入模仿列表
- **备份恢复机制**: 更新前自动备份，支持一键回滚
- **风格一致性**: 确保人格演化的连贯性和稳定性

### 🤖 轻量级机器学习
- **scikit-learn集成**: 可选ML分析，自动降级到基础统计
- **文本聚类分析**: TF-IDF + K-means进行话题聚类
- **行为模式识别**: 用户活跃度、互动倾向分析
- **情感趋势分析**: 基于关键词的群聊氛围识别

### 💬 智能回复系统  
- **上下文感知**: 基于用户画像和社交关系的智能回复
- **概率触发**: 可配置回复概率，避免过度活跃
- **框架集成**: 调用AstrBot默认LLM，保持一致性
- **社交强度**: 根据用户关系强度调整回复策略

## 🏗️ 完整架构设计

### 核心服务层
```
services/
├── database_manager.py         # 分群数据库管理器
├── message_collector.py        # 异步消息收集服务
├── multidimensional_analyzer.py # 多维度用户分析器
├── style_analyzer.py           # 对话风格分析服务
├── learning_quality_monitor.py # 学习质量监控系统
├── progressive_learning.py     # 渐进式学习协调器
├── intelligent_responder.py    # 智能回复生成器
├── ml_analyzer.py              # 轻量级ML分析器
└── persona_backup_manager.py   # 人格备份管理器
```

### 数据存储架构
- **分群存储**: 每个群单独的SQLite数据库
- **表结构设计**: 原始消息、筛选消息、用户画像、社交关系、备份数据
- **索引优化**: 针对时间戳、用户ID、消息类型的高效索引
- **数据生命周期**: 自动清理、备份轮转、存储优化

### 配置管理系统  
- **分层配置**: 基础设置、学习参数、ML设置、智能回复、备份设置
- **动态验证**: 实时参数校验和错误提示
- **热更新**: 支持运行时配置修改
- **默认优化**: 针对不同使用场景的预设配置

## ⚙️ 详细功能说明

### 1. 消息捕获与筛选
**工作流程**:
1. 监听所有群消息和私聊消息
2. 根据`target_qq_list`配置过滤目标用户
3. 应用长度过滤、内容质量检查
4. 异步存储到对应群数据库
5. 可选实时筛选处理

**关键特性**:
- 支持正则表达式QQ号匹配
- 消息去重算法（基于内容hash）
- 批量写入优化（减少数据库I/O）
- 错误恢复机制

### 2. 多维度用户分析
**用户画像维度**:
- **活动模式**: 上线时间分布、消息频率曲线
- **沟通风格**: 消息长度偏好、表情使用习惯、标点符号特征
- **话题偏好**: 基于关键词和语义分析的兴趣挖掘
- **社交行为**: @频率、回复倾向、群内角色识别

**社交图谱分析**:
- **关系强度量化**: 基于互动频率、回复及时性
- **影响力评估**: 被@频率、消息传播效应
- **群体角色**: 活跃者、潜水者、调解者识别
- **关系网络**: 基于NetworkX的关系可视化

### 3. 智能学习引擎
**学习策略**:
- **分层筛选**: 长度过滤 → 内容相关性 → 风格匹配度
- **质量评估**: 语言质量、情感倾向、上下文连贯性
- **批次优化**: 智能批大小调整，避免内存溢出
- **增量学习**: 支持在线学习，无需重新训练

**模型协作**:
- **弱模型任务**: 快速分类、关键词提取、基础NLP
- **强模型任务**: 深度语义理解、风格特征提炼、人格优化
- **模型切换**: 智能负载均衡，成本效益优化

### 4. 人格进化机制  
**进化流程**:
1. 获取当前框架默认人格设置
2. 分析筛选消息的风格特征
3. 使用强模型生成优化建议
4. 质量监控评估变更影响
5. 渐进式应用人格更新
6. 添加优质样本到模仿列表

**安全保障**:
- **自动备份**: 每次更新前创建完整备份
- **版本管理**: 支持多版本人格历史
- **回滚机制**: 一键恢复到任意历史版本
- **一致性检查**: 确保人格变更的连贯性

## 🔧 配置参数详解

### 基础学习设置 (`Self_Learning_Basic`)
```json
{
  "enable_message_capture": true,    // 启用消息抓取
  "enable_auto_learning": true,      // 启用自动学习
  "enable_realtime_learning": false, // 启用实时学习(消耗资源)
  "enable_web_interface": false      // 启用Web管理界面
}
```

### 抓取目标设置 (`Target_Settings`)  
```json
{
  "target_qq_list": [],              // 目标QQ号列表，空=全部
  "current_persona_name": "default"  // 当前目标人格名称
}
```

### 模型配置 (`Model_Configuration`)
```json
{
  "filter_model_name": "gpt-4o-mini", // 筛选模型(建议轻量)
  "refine_model_name": "gpt-4o"       // 提炼模型(建议强力)
}
```

### 学习参数 (`Learning_Parameters`)
```json
{
  "learning_interval_hours": 6,       // 学习间隔
  "min_messages_for_learning": 50,    // 最少学习消息数
  "max_messages_per_batch": 200       // 批处理大小
}
```

### 机器学习设置 (`Machine_Learning_Settings`)
```json
{
  "enable_ml_analysis": true,         // 启用ML分析
  "max_ml_sample_size": 100,          // 样本数限制
  "ml_cache_timeout_hours": 1         // 缓存超时
}
```

### 智能回复设置 (`Intelligent_Reply_Settings`)
```json
{
  "enable_intelligent_reply": false,  // 启用智能回复
  "reply_probability": 0.1,           // 回复触发概率
  "context_window_size": 5            // 上下文窗口
}
```

## 🚦 使用指南

### 快速开始
1. **安装依赖**: `pip install -r requirements.txt`
2. **配置插件**: 在AstrBot管理界面配置相关参数
3. **启用插件**: 加载插件并启动消息捕获
4. **监控学习**: 使用命令查看学习状态

### 命令参考
- `/learning_status` - 查看详细学习状态和统计信息
- `/start_learning` - 手动启动自动学习循环  
- `/stop_learning` - 停止自动学习循环
- `/force_learning` - 强制执行一次完整学习周期
- `/clear_data` - 清空所有学习数据（谨慎使用）
- `/export_data` - 导出学习数据为JSON格式

### 性能调优建议
1. **资源控制**: 调整`max_ml_sample_size`控制内存使用
2. **学习频率**: 根据群活跃度调整`learning_interval_hours`
3. **质量阈值**: 提高`confidence_threshold`获得更高质量
4. **缓存优化**: 合理设置`ml_cache_timeout_hours`

## 📊 数据存储说明

### 数据库表结构
- **raw_messages**: 原始消息存储
- **filtered_messages**: 筛选后的消息
- **user_profiles**: 用户画像数据
- **social_relations**: 社交关系图谱
- **style_profiles**: 风格档案历史
- **persona_backups**: 人格备份记录
- **learning_sessions**: 学习会话日志

### 数据隐私保护
- 本地存储，不上传到云端
- 支持数据加密存储（可选）
- 用户数据自主控制和删除
- 遵循数据最小化原则

## 🔍 故障排除

### 常见问题
1. **内存占用过高**: 降低`max_ml_sample_size`和`max_messages_per_batch`
2. **学习效果不佳**: 提高`min_messages_for_learning`，检查数据质量
3. **人格变化异常**: 查看备份记录，考虑回滚操作
4. **数据库锁定**: 重启插件，检查磁盘空间

### 日志分析
- 学习质量得分低于0.7时会记录警告
- 数据库操作失败会记录详细错误信息
- ML分析异常会自动降级到基础统计

## 🛡️ 安全特性

### 质量保障
- **多级质量监控**: 实时评估学习质量
- **异常检测**: 自动识别风格偏移
- **人工介入点**: 关键节点提示人工检查
- **回滚保护**: 任何时候都可以安全回滚

### 资源保护  
- **内存限制**: 智能样本大小控制
- **CPU节流**: 异步处理，避免阻塞主线程
- **磁盘管理**: 自动清理过期数据
- **网络优化**: 批量API调用，减少请求频率

## 📈 技术实现亮点

### 异步架构设计
- 全异步消息处理管道
- 数据库连接池管理
- 并发控制和资源限制
- 优雅的错误处理和恢复

### 机器学习集成
- 可选scikit-learn依赖
- 自动特征工程
- 增量学习支持
- 模型性能监控

### 扩展性设计
- 模块化服务架构
- 插件化分析器
- 可配置学习策略
- 开放的API接口

本插件实现了从消息捕获到人格优化的完整智能学习链路，通过科学的质量控制和资源管理，确保在提供强大功能的同时保持系统稳定性和用户数据安全。

## 🏗️ 架构设计

```
astrabot_plugin_self_learning/
├── main.py                     # 插件主入口
├── config.py                   # 配置管理
├── _conf_schema.json          # 配置架构
├── metadata.yaml              # 插件元数据
├── exceptions.py              # 异常定义
├── services/                  # 核心服务层
│   ├── message_collector.py        # 消息收集服务
│   ├── multidimensional_analyzer.py # 多维度分析器
│   ├── style_analyzer.py           # 风格分析服务  
│   ├── learning_quality_monitor.py # 学习质量监控
│   └── progressive_learning.py     # 渐进式学习服务
```

## 🔧 配置说明

### 基础配置
- `capture_enabled`: 启用消息抓取
- `auto_learning_enabled`: 启用自主学习
- `web_interface_enabled`: 启用Web管理界面

### 抓取配置
- `target_qq_list`: 目标QQ号列表(空则抓取所有)
- `current_persona`: 当前人格设定

### 模型配置
- `filter_model_name`: 筛选模型名称
- `refine_model_name`: 提炼模型名称
- `quality_threshold`: 质量阈值
- `learning_batch_size`: 学习批次大小
- `learning_interval_minutes`: 学习间隔(分钟)

## 🎯 核心服务详解

### 1. 消息收集服务 (MessageCollectorService)
- SQLite数据库存储原始消息和筛选后消息
- 批量写入优化，减少I/O开销
- 消息状态管理和处理追踪

### 2. 多维度分析器 (MultidimensionalAnalyzer) 
- **用户画像**: 活动时间、消息长度偏好、话题兴趣
- **社交分析**: @关系、回复关系、群内角色识别
- **上下文分析**: 时间模式、话题相关性、情感倾向
- **LLM驱动**: 使用提示词进行智能特征提取

### 3. 风格分析服务 (StyleAnalyzerService)
- **深度分析**: 词汇丰富度、句式复杂度、情感表达
- **风格档案**: 量化的风格特征评分系统
- **演化追踪**: 记录风格变化历史和趋势
- **优化建议**: 基于目标人格生成改进建议

### 4. 学习质量监控 (LearningQualityMonitor)
- **一致性检查**: 确保人格更新的连贯性
- **稳定性监控**: 防止风格突然变化
- **偏移检测**: 及时发现风格异常偏移
- **警报系统**: 多级警报和人工介入建议

### 5. 渐进式学习服务 (ProgressiveLearningService)
- **协调中心**: 统一管理所有学习组件
- **批次处理**: 智能的学习批次调度
- **质量控制**: 基于质量评估的学习决策
- **状态管理**: 完整的学习会话追踪

## 🔄 工作流程

1. **消息捕获**: 实时监听并收集目标用户的对话消息
2. **初步筛选**: 使用弱LLM模型快速过滤有价值的内容
3. **多维分析**: 深度分析用户特征、社交关系和上下文
4. **风格提炼**: 使用强LLM模型提炼对话风格特征
5. **质量评估**: 监控学习质量，确保人格一致性
6. **人格更新**: 动态更新BOT人格和对话样本
7. **效果追踪**: 持续监控学习效果和风格演化

## 📊 质量保证

### 学习质量指标
- **一致性得分**: 人格更新的连贯性
- **稳定性得分**: 风格变化的平稳性  
- **多样性得分**: 词汇和表达的丰富度
- **相关性得分**: 与目标人格的匹配度

### 安全机制
- **质量阈值**: 低质量学习自动拒绝
- **风格偏移检测**: 异常变化及时暂停
- **人工审核建议**: 关键节点提醒人工介入
- **回滚机制**: 支持恢复到历史版本

## 🚦 使用命令

- `/learning_status` - 查看学习状态和统计
- `/start_learning` - 手动启动自动学习  
- `/stop_learning` - 停止自动学习
- `/force_learning` - 强制执行一次学习周期
- `/clear_data` - 清空所有学习数据
- `/export_data` - 导出学习数据

## 🔮 未来规划

- Web可视化管理界面
- 更多社交关系分析维度
- 情感智能和语境理解
- 多语言支持
- 分布式学习架构

## 📝 开发说明

本插件基于AstrBot框架设计，充分利用了现代异步编程和LLM技术，实现了一坨对话风格学习和人格优化系统。
